name: Slack Notification

on:
  pull_request:
    types: [review_requested]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  slack-notify:
    runs-on: ubuntu-latest
    if: ${{ !endsWith(github.actor, '[bot]') }}
    steps:
      - name: Map GitHub User to Slack Member ID
        id: slack-mapper
        shell: bash
        run: |
          # ---------------------------------------------------
          # [1] ë°ì´í„° ì¶”ì¶œ ë° ì´ˆê¸°í™”
          # ---------------------------------------------------
          TARGET_GITHUB_ID=""
          EVENT_TYPE="${{ github.event_name }}"
          COMMENT_BODY=""
          MSG_HEADER=""
          PREVIEW_TEXT=""
          SHOULD_SEND="false"
          
          # Case A: ì‚¬ì´ë“œë°”ì—ì„œ ë¦¬ë·°ì–´ë¡œ ì§€ì • (Re-request í¬í•¨)
          if [[ "$EVENT_TYPE" == "pull_request" ]]; then
            TARGET_GITHUB_ID="${{ github.event.requested_reviewer.login }}"
            MSG_HEADER="ğŸ“¢ ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!"
            PREVIEW_TEXT="ë¦¬ë·°ì–´ë¡œ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            SHOULD_SEND="true" # ë¦¬ë·°ì–´ ì§€ì •ì€ ë¬´ì¡°ê±´ ì „ì†¡
          
          # Case B: ë¦¬ë·° ì œì¶œ (Approve, Request Changes, Review Comment)
          elif [[ "$EVENT_TYPE" == "pull_request_review" ]]; then
            COMMENT_BODY="${{ github.event.review.body }}"
            STATE="${{ github.event.review.state }}"
          
            if [[ "$STATE" == "APPROVED" ]]; then
              MSG_HEADER="âœ… PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
            elif [[ "$STATE" == "CHANGES_REQUESTED" ]]; then
              MSG_HEADER="ğŸš§ ë³€ê²½ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤!"
            else
              MSG_HEADER="ğŸ’¬ ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ë‹¬ë ¸ìŠµë‹ˆë‹¤!"
            fi

          # Case C: ì¼ë°˜ ëŒ“ê¸€ / ì½”ë“œ ë¼ì¸ ëŒ“ê¸€
          elif [[ "$EVENT_TYPE" == "issue_comment" || "$EVENT_TYPE" == "pull_request_review_comment" ]]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            MSG_HEADER="ğŸ’¬ ìƒˆë¡œìš´ ë©˜ì…˜/ëŒ“ê¸€ì´ ìˆìŠµë‹ˆë‹¤!"
          fi

          # í…ìŠ¤íŠ¸ ìš”ì•½ ì²˜ë¦¬ (ë‚´ìš©ì´ ìˆì„ ê²½ìš°)
          if [[ -n "$COMMENT_BODY" ]]; then
            if [ ${#COMMENT_BODY} -gt 100 ]; then
              PREVIEW_TEXT="${COMMENT_BODY:0:100} ..."
            else
              PREVIEW_TEXT="$COMMENT_BODY"
            fi
          fi

          # ---------------------------------------------------
          # [2] íŒ€ì› ë§¤í•‘ ë° ì „ì†¡ ì—¬ë¶€ ê²°ì •
          # ---------------------------------------------------
          SLACK_MENTION=""

          # ë§¤í•‘ í•¨ìˆ˜
          check_mention() {
            local github_id=$1
            local slack_id=$2
            # ë¦¬ë·°ì–´ë¡œ ì§€ì •ëê±°ë‚˜ ë³¸ë¬¸ì— @ì•„ì´ë””ê°€ í¬í•¨ëœ ê²½ìš°
            if [[ "$TARGET_GITHUB_ID" == "$github_id" ]] || [[ "$COMMENT_BODY" == *"$github_id"* ]]; then
              SLACK_MENTION="$SLACK_MENTION <@$slack_id>"
              SHOULD_SEND="true" # ë§¤ì¹­ë˜ëŠ” ë©˜ì…˜ì´ ìˆë‹¤ë©´ ì „ì†¡ í™•ì •
            fi
          }

          check_mention "godqhrenf" "U0ACQ0WAY3T"
          check_mention "ParkGoeun00" "U0AC8LPUHKP"
          check_mention "zoo-brong" "U0AC8LPD093"
          check_mention "jk-Nam" "U0ACA29BKBQ"

          # ---------------------------------------------------
          # [3] í™˜ê²½ ë³€ìˆ˜ ë‚´ë³´ë‚´ê¸°
          # ---------------------------------------------------
          echo "SLACK_MENTION=$SLACK_MENTION" >> $GITHUB_ENV
          echo "MSG_HEADER=$MSG_HEADER" >> $GITHUB_ENV
          echo "SHOULD_SEND=$SHOULD_SEND" >> $GITHUB_ENV
          echo "PREVIEW_TEXT<<EOF" >> $GITHUB_ENV
          echo "${PREVIEW_TEXT:-ë‚´ìš© ì—†ìŒ}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Slack Notification
        if: ${{ env.SHOULD_SEND == 'true' }}
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_USERNAME: GitBot
          SLACK_COLOR: '#36a64f'
          SLACK_TITLE: "${{ env.MSG_HEADER }}"
          SLACK_MESSAGE: |
            *PR:* ${{ github.event.pull_request.title || github.event.issue.title }}
            *ë§í¬:* ${{ github.event.pull_request.html_url || github.event.review.html_url || github.event.comment.html_url }}
            *ì‘ì„±ì:* ${{ github.actor }}
            
            *ë‚´ìš©:*
            > ${{ env.PREVIEW_TEXT }}
            
            ${{ env.SLACK_MENTION }} í™•ì¸ ë¶€íƒë“œë ¤ìš”!

          SLACK_FOOTER: 'Powered by GitHub Actions'
